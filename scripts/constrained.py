#!/usr/bin/pythonimport numpy as npimport pytorch_lightning as plimport torchfrom pytorch_lightning.loggers import CometLoggerfrom torch.utils.data import Dataset, random_split, TensorDatasetfrom alegnn.utils import graphToolsfrom alegnn.modules.architectures import SelectionGNNfrom pyopf.data import load_datafrom pyopf.modules import OPFLogBarrierfrom pyopf.power import load_case, NetworkManagertorch.autograd.set_detect_anomaly(True)# Constantsdata_dir = "./data"ratio_train = 0.8device = torch.device("cpu")F0 = 4# Meta-parametersA_scaling = 0.001A_threshold = 0.01case = "case30"# instantiate the NetworkManagermanager = NetworkManager(load_case(case, data_dir), A_scaling, A_threshold)N = manager.n_buses# Parameters / Configurationparam = {    "train": dict(        max_epochs=20,        batch_size=515    ),    "gnn": dict(        dimLayersMLP=[4 * N],        dimNodeSignals=[F0, 64],        nFilterTaps=[4],        poolingSize=[1],        nSelectedNodes=[N]    ),    "barrier": dict(        type="relaxed_log",  # log, relaxed_log        t=200,  # higher -> better approximation to barrier        s=100,  # the slope at which the barrier becomes linear        cost_weight=0.01,    ),    "meta": dict(        A_scaling=A_scaling,        A_threshold=A_threshold,        model="selection",        case=case    ),}# Prepare graph shift operatoradjacencyMatrix = manager.get_adjacency()G = graphTools.Graph("adjacency", adjacencyMatrix.shape[0], {"adjacencyMatrix": adjacencyMatrix})G.computeGFT()S, order = graphTools.permDegree(G.S / np.max(np.real(G.E)))  # normalize GSO by dividing by largest e-value# Load data and convert from numpy to torch tensors.train_samples, test_samples, test_labels = load_data(case, data_dir)train_data = TensorDataset(torch.from_numpy(train_samples).to(device))test_data = TensorDataset(torch.from_numpy(test_samples).to(device), torch.from_numpy(test_labels).to(device))train_split = int(len(train_data) * ratio_train)val_split = len(train_data) - train_splittrain_data, val_data = random_split(train_data, [train_split, val_split])train_loader = torch.utils.data.DataLoader(train_data, batch_size=param["train"]["batch_size"], shuffle=True)val_loader = torch.utils.data.DataLoader(val_data, batch_size=param["train"]["batch_size"])test_loader = torch.utils.data.DataLoader(test_data, batch_size=param["train"]["batch_size"])gnn = SelectionGNN(GSO=S, **param["gnn"])barrier = OPFLogBarrier(manager, gnn, **param["barrier"]).to("cuda")logger = CometLogger(workspace="damowerko", project_name="opf", save_dir="../../logs")logger.log_hyperparams(param)trainer = pl.Trainer(logger=logger, gpus=1)trainer.fit(barrier, train_loader, val_loader)